#!/usr/bin/env python3
"""
Script to create admin user for Baitech
Usage: python3 setup_admin.py.example

For security:
1. Copy this file: cp setup_admin.py.example setup_admin.py
2. Edit admin credentials in setup_admin.py
3. Run: python3 setup_admin.py
4. Delete setup_admin.py after use (it's in .gitignore)
"""
import asyncio
import os
from utils.database import db
from utils.security import hash_password

async def setup_admin():
    # Admin credentials - CHANGE THESE!
    admin_data = {
        "name": "Baitech Admin",
        "email": os.getenv("ADMIN_EMAIL", "admin@baitech.com"),
        "password": hash_password(os.getenv("ADMIN_PASSWORD", "ChangeMe123!")),
        "role": "admin"
    }

    # Check if admin exists
    existing = await db.users.find_one({"email": admin_data["email"]})

    if existing:
        print(f"⚠ Admin user already exists: {admin_data['email']}")
        print(f"   Name: {existing.get('name')}")
        print(f"   Role: {existing.get('role')}")

        # Update to ensure admin role
        await db.users.update_one(
            {"email": admin_data["email"]},
            {"$set": {"role": "admin"}}
        )
        print("✓ Ensured admin role is set")
    else:
        # Create new admin
        result = await db.users.insert_one(admin_data)
        print("✓ Admin user created successfully!")
        print(f"  ID: {result.inserted_id}")

    print("\n" + "=" * 60)
    print("ADMIN LOGIN CREDENTIALS")
    print("=" * 60)
    print(f"Email:    {admin_data['email']}")
    print(f"Password: [SET VIA ADMIN_PASSWORD ENV VAR]")
    print(f"Role:     admin")
    print("\n⚠ IMPORTANT: Change the password after first login!")
    print("\nLogin at: http://localhost:3000/login")
    print("=" * 60)

    # List all admins
    print("\nAll Admin Users:")
    admins = await db.users.find({"role": "admin"}).to_list(100)
    for i, admin in enumerate(admins, 1):
        print(f"  {i}. {admin.get('name')} - {admin.get('email')}")

if __name__ == "__main__":
    print("Setting up Baitech admin user...\n")
    print("⚠ Use environment variables ADMIN_EMAIL and ADMIN_PASSWORD")
    print("  Example: ADMIN_EMAIL=admin@example.com ADMIN_PASSWORD=SecurePass123 python3 setup_admin.py\n")
    asyncio.run(setup_admin())
